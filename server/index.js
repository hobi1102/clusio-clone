const express = require('express'); const path = require('path'); const Database = require('better-sqlite3'); const { spawn } = require('child_process'); const fs = require('fs'); const multer = require('multer'); // Configure Multer for file uploads const storage = multer.diskStorage({ destination: function (req, file, cb) { const uploadDir = path.join(__dirname, 'uploads'); if (!fs.existsSync(uploadDir)) { fs.mkdirSync(uploadDir); } cb(null, uploadDir); }, filename: function (req, file, cb) { const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9); cb(null, uniqueSuffix + path.extname(file.originalname)); } }); const upload = multer({ storage: storage }); const app = express(); app.use('/uploads', express.static(path.join(__dirname, 'uploads'))); // Serve uploads const port = process.env.PORT || 3000; // Database setup const db = new Database('database.db'); db.exec(` CREATE TABLE IF NOT EXISTS projects ( id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, type TEXT DEFAULT 'video', status TEXT DEFAULT 'Processing', created_at DATETIME DEFAULT CURRENT_TIMESTAMP ); CREATE TABLE IF NOT EXISTS users ( id INTEGER PRIMARY KEY AUTOINCREMENT, email TEXT UNIQUE NOT NULL, password TEXT NOT NULL, name TEXT ); `); // Migration for existing databases try { db.exec("ALTER TABLE projects ADD COLUMN type TEXT DEFAULT 'video'"); } catch (err) { // Column already exists } try { db.exec("ALTER TABLE projects ADD COLUMN content TEXT DEFAULT '{}'"); } catch (err) { // Column already exists } app.use(express.json()); app.use(express.static(path.join(__dirname, '../public'))); // API Routes app.get('/api/projects', (req, res) => { const projects = db.prepare('SELECT * FROM projects ORDER BY created_at DESC').all(); // Parse content JSON if needed, or send as string res.json(projects.map(p => ({ ...p, content: safeJSONParse(p.content) }))); }); app.get('/api/projects/:id', (req, res) => { const project = db.prepare('SELECT * FROM projects WHERE id = ?').get(req.params.id); if (project) { res.json({ ...project, content: safeJSONParse(project.content) }); } else { res.status(404).json({ error: 'Project not found' }); } }); app.post('/api/projects', (req, res) => { const { name, type, content } = req.body; const projectType = type || 'video'; const initialContent = content ? JSON.stringify(content) : '{}'; const info = db.prepare('INSERT INTO projects (name, type, content) VALUES (?, ?, ?)').run(name, projectType, initialContent); // Trigger Python "AI Processing" script const pythonProcess = spawn('python', ['./scripts/process_video.py', info.lastInsertRowid]); pythonProcess.stdout.on('data', (data) => { // Silence output in production }); res.json({ id: info.lastInsertRowid, status: 'Processing', type: projectType }); }); app.put('/api/projects/:id', (req, res) => { const { name, content, status } = req.body; let query = "UPDATE projects SET "; const params = []; const updates = []; if (name) { updates.push("name = ?"); params.push(name); } if (content) { updates.push("content = ?"); params.push(JSON.stringify(content)); } if (status) { updates.push("status = ?"); params.push(status); } // Always update updated_at if we had that column, but we don't. // Just run update if we have fields. if (updates.length === 0) return res.json({ success: true }); query += updates.join(", ") + " WHERE id = ?"; params.push(req.params.id); const info = db.prepare(query).run(...params); if (info.changes > 0) { res.json({ success: true }); } else { res.status(404).json({ error: 'Project not found' }); } }); app.post('/api/projects/:id/publish', (req, res) => { const info = db.prepare("UPDATE projects SET status = 'Published' WHERE id = ?").run(req.params.id); if (info.changes > 0) { res.json({ success: true, status: 'Published' }); } else { res.status(404).json({ error: 'Project not found' }); } }); // AI Feature Endpoints app.post('/api/ai/tts', (req, res) => { const { text, voice } = req.body; // Dynamic stub: Return success with a mock URL // In a real app, you'd pipe the audio buffer here. setTimeout(() => { res.json({ success: true, audioUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // Public sample audio duration: Math.ceil(text.length / 10) // Approx 1s per 10 chars }); }, 1000); }); app.post('/api/ai/rewrite', (req, res) => { const { text, tone } = req.body; // "Smart" Rule-based Mock // 1. Expand contractions // 2. Add "professional" prefix/suffix based on tone let refined = text .replace(/can't/g, 'cannot') .replace(/don't/g, 'do not') .replace(/it's/g, 'it is') .replace(/I'm/g, 'I am'); if (tone === 'professional') { refined = refined + " Furthermore, this solution allows for comprehensive scalability."; } else if (tone === 'friendly') { refined = "Hey there! " + refined + " Hope that helps!"; } setTimeout(() => { res.json({ success: true, text: refined }); }, 800); }); app.post('/api/upload', upload.single('file'), (req, res) => { if (!req.file) { return res.status(400).json({ success: false, error: 'No file uploaded' }); } const fileUrl = `/uploads/${req.file.filename}`; res.json({ success: true, url: fileUrl, filename: req.file.filename }); }); app.post('/api/ai/translate', (req, res) => { const { text, targetLang, sourceLang } = req.body; // Stub translation // In a real app, this would call Google Translate/OpenAI API const translated = `[${targetLang}] ${text}`; setTimeout(() => { res.json({ success: true, text: translated, lang: targetLang }); }, 1500); }); app.post('/api/ai/cuts', (req, res) => { const { projectId } = req.body; // Stub: Return a list of "cuts" to be made setTimeout(() => { res.json({ success: true, cuts: [ { start: 2.5, end: 3.2, reason: 'silence' }, { start: 8.1, end: 8.9, reason: 'filler word' }, { start: 15.4, end: 16.0, reason: 'silence' } ] }); }, 2000); }); app.post('/api/projects/:id/export', (req, res) => { // export project logic // Simulate export process // In reality, this would start a background job (FFmpeg etc) // Update status to 'Exporting' db.prepare("UPDATE projects SET status = 'Exporting' WHERE id = ?").run(req.params.id); setTimeout(() => { // Complete export db.prepare("UPDATE projects SET status = 'Published' WHERE id = ?").run(req.params.id); console.log(`Export complete for ${req.params.id}`); }, 5000); // 5 sec fake render res.json({ success: true, message: 'Export started', downloadUrl: '/downloads/project_final.mp4' }); }); function safeJSONParse(str) { try { return JSON.parse(str); } catch (e) { return {}; } } app.post('/api/signup', (req, res) => { const { email, password, name } = req.body; try { const info = db.prepare('INSERT INTO users (email, password, name) VALUES (?, ?, ?)').run(email, password, name); res.json({ success: true, userId: info.lastInsertRowid }); } catch (err) { res.status(400).json({ error: 'Email already exists' }); } }); app.post('/api/login', (req, res) => { const { email, password } = req.body; const user = db.prepare('SELECT * FROM users WHERE email = ? AND password = ?').get(email, password); if (user) { res.json({ success: true, user: { name: user.name, email: user.email } }); } else { res.status(401).json({ error: 'Invalid credentials' }); } }); // Serve HTML pages app.get('/', (req, res) => res.sendFile(path.join(__dirname, '../public/index.html'))); app.get('/login', (req, res) => res.sendFile(path.join(__dirname, '../public/login.html'))); app.get('/signup', (req, res) => res.sendFile(path.join(__dirname, '../public/signup.html'))); app.get('/dashboard', (req, res) => res.sendFile(path.join(__dirname, '../public/dashboard.html'))); app.get('/projects', (req, res) => res.sendFile(path.join(__dirname, '../public/projects.html'))); app.get('/pricing', (req, res) => res.sendFile(path.join(__dirname, '../public/pricing.html'))); // Feature Pages Routes app.get('/features/videos', (req, res) => res.sendFile(path.join(__dirname, '../public/features/videos.html'))); app.get('/features/documentation', (req, res) => res.sendFile(path.join(__dirname, '../public/features/documentation.html'))); app.get('/features/translate', (req, res) => res.sendFile(path.join(__dirname, '../public/features/translate.html'))); app.get('/features/voiceovers', (req, res) => res.sendFile(path.join(__dirname, '../public/features/voiceovers.html'))); app.get('/features/slides-to-video', (req, res) => res.sendFile(path.join(__dirname, '../public/features/slides-to-video.html'))); // Resource Pages Routes app.get('/resources/blog', (req, res) => res.sendFile(path.join(__dirname, '../public/resources/blog.html'))); app.get('/resources/help-center', (req, res) => res.sendFile(path.join(__dirname, '../public/resources/help-center.html'))); app.get('/resources/faq', (req, res) => res.sendFile(path.join(__dirname, '../public/resources/faq.html'))); app.listen(port, () => { console.log(`Server running at http://localhost:${port}`); });
